entities:
  mm_discovery.stalker:
    title: Исследователь метамодели
    menu: >
      (
          [$."mm_discovery.stalker".$spread().(
              {
                  "link": "/entities/mm_discovery.stalker/map_smartants?id=" & $keys()[0], 
                  "location": *.location 
              }

          )]
      )
    schema:
      type: object
      patternProperties:
        "^[a-zA-Z][a-zA-Z0-9_-]*(\\.[a-zA-Z][a-zA-Z0-9_-]*)*$":
          type: object
          properties:
            title:
              title: Название
              type: string
            location:
              title: Размещение
              type: string
            nodes:
              title: Виртуальные ноды
              patternProperties:
                "^[a-zA-Z][a-zA-Z0-9_-]*(\\.[a-zA-Z][a-zA-Z0-9_-]*)*$":
                  type: object
                  properties:
                    title:
                      type: string
                      title: Название
                    symbol:
                      type: string
                      title: Символ
                  required:
                    - title
              additionalProperties: false
            domains:
              title: Выборка доменов
              type: array
              items:
                title: Фильтр доменов
                type: string
            hooks:
              type: object
              title: Обработчики данных
              properties:
                after:
                  title: Пост обработчик
                  type: string
                before:
                  title: Предобработчик
                  type: string

          required:
            - title
            - domains
      additionalProperties: false
    presentations:
      map_smartants:
        title: Карта сущностей метамодели
        type: smartants
        params:
          type: object
          properties:
            id:
              title: Идентификатор
              type: string
          required:
            - id
        source: >
          (
              $context := $lookup($."mm_discovery.stalker", $params.id);
              $data := $context.hooks.before ? $eval($context.hooks.before, $) : $;
              $defs := $merge(entities.*.schema."$defs");
              $scan_props := function($props) {(
                  $props.$keys().(
                      $scan($lookup($props, $));
                  );
              )};
          
              $scan := function($schema) {(
                  $r1 := $schema.type = "object" 
                      ? $scan_props($merge([$schema.properties, $schema.patternProperties]));
                  $r2 := $schema.type = "array"
                      ? $scan($schema.items);
                  $r3 := $schema."$ref"~>$substring(0, 8) = "#/$rels/" 
                      ? $schema."$ref"~>$substring(8);
                  $r4 := $schema."$ref"~>$substring(0, 8) = "#/$defs/"
                      ? $scan($lookup($defs, $schema."$ref"~>$substring(8)));
                  $append(
                      $append($r1, $r2),
                      $append($r3, $r4)
                  );
              )};
          
              $mm_map := $data.entities.$spread()[*.objects].(
                  $entity_id := $keys()[0];
                  $append($distinct($scan(*.schema)).{
                        "entity": $entity_id,
                        "ref": $~>$split(".")~>$map(
                                    function($v, $i, $a) {
                                        $i < $count($a) - 1 ? $v
                                    }
                                )~>$join(".")
                    },
                    {
                      "entity": $entity_id
                    }
                  );
              );
              $isFetch := function($domain) {(
                  ($context.domains.$wcard($domain, $))[$]
              )};   
              $result := {
                  "header": {
                      "title": $context.title 
                  },   
                  "nodes": $merge([
                    $context.nodes,
                    $merge($distinct($mm_map.entity).(
                      $id := $;
                      $isFetch($id) ? (
                        $struct := $split($, ".");
                        $group := $replace("$." & $, "." & $reverse($struct)[0], "");
                        $lookup($data.entities, $id).{
                          $id: {
                            "title": title ? title : $id,
                            "symbol": "system"
                          }
                        }
                      )
                    ))
                  ]),
                  "links": [$mm_map[ref]~>$map(function($v, $i){(
                      $isFetch($v.entity) and $isFetch($v.ref) ? 
                        {
                         "from": $v.entity,
                         "to": $v.ref,
                         "style": "->"
                        }
                  )})],
                  "config": {
                      "distance": 10,
                      "trackWidth": 16
                  }      
              };
              $context.hooks.after ? $eval($context.hooks.after, {
                  "result" : $result,
                  "data": $data,
                  "manifest": $
              }) : $result;
          )
